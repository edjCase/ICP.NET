using EdjCase.ICP.Agent;
using EdjCase.ICP.Agent.Agents;
using EdjCase.ICP.Agent.Agents.Http;
using EdjCase.ICP.Agent.Identities;
using EdjCase.ICP.Agent.Models;
using EdjCase.ICP.Agent.Requests;
using EdjCase.ICP.Agent.Responses;
using EdjCase.ICP.Candid;
using EdjCase.ICP.Candid.Models;
using EdjCase.ICP.Candid.Utilities;
using Moq;
using System;
using System.Formats.Cbor;
using System.Net;
using System.Threading;
using System.Threading.Tasks;
using Xunit;

namespace Agent.Tests
{
	public class HttpAgentTests
	{
		private static readonly Principal canisterId = Principal.FromText("j4n55-giaaa-aaaap-qb3wq-cai");
		private static readonly IIdentity identity = IdentityUtil.GenerateEd25519Identity();
		private static readonly Uri boundaryNodeUrl = new("https://icp-api.io/");
		private static readonly SubjectPublicKeyInfo rootPublicKey = SubjectPublicKeyInfo.MainNetRootPublicKey;


		//[Fact]
		//public async Task CallAsync_SuccessfulResponse_ReturnsReply()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object, skipCertificateValidation: true);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));
		//	CallRequest request = new(canisterId, "greet", CandidArg.FromCandid(), sender, ingressExpiry);
		//	SignedRequest<CallRequest> signedContent = identity.Sign(request);


		//	byte[] responseBytes = [];
		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.OK, responseBytes);

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v3/canister/")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act
		//	CandidArg result = await agent.CallAsync(signedContent);

		//	// Assert
		//	Assert.NotNull(result);
		//	Assert.Equal("hello", result.ToObjects<string>());
		//}

		//[Fact]
		//public async Task CallAsync_NotFoundResponse_FallsBackToV2()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object, skipCertificateValidation: true);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));
		//	CallRequest request = new(canisterId, "greet", CandidArg.FromCandid(), sender, ingressExpiry);
		//	var signedContent = identity.Sign(request);

		//	// V3 returns 404
		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v3/canister/")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(CreateHttpResponse(HttpStatusCode.NotFound, Array.Empty<byte>()));

		//	// V2 Call setup (returns 202 Accepted)
		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/canister/") && url.Contains("/call")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(CreateHttpResponse(HttpStatusCode.Accepted, Array.Empty<byte>()));

		//	byte[] readStateResponseBytes = [];

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/canister/") && url.Contains("/read_state")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(CreateHttpResponse(HttpStatusCode.OK, readStateResponseBytes));

		//	// Act
		//	var result = await agent.CallAsync(signedContent);

		//	// Assert
		//	Assert.NotNull(result);
		//	Assert.Equal("hello", result.ToObjects<string>());
		//}

		//[Fact]
		//public async Task CallAsync_AcceptedResponse_PollsUntilComplete()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object, skipCertificateValidation: true);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));
		//	CallRequest request = new(canisterId, "greet", CandidArg.FromCandid(), sender, ingressExpiry);
		//	var signedContent = identity.Sign(request);

		//	// V3 returns 202 Accepted (requires polling)
		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v3/canister/")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken?>()))
		//		.ReturnsAsync(CreateHttpResponse(HttpStatusCode.Accepted, Array.Empty<byte>()));

		//	byte[] readStateResponseBytes = ByteUtil.FromHexString("D9D9F7A16B6365727469666963617465594DC5D9D9F7A36474726565830183018301820458207F795EAF211FB3DA321D2291429BAD43A869A1CCFD761FF5A35F1A362322A1F483024863616E69737465728301830183018301820458205DB6DC6606E09F81ACC75F54F096750D2E63CFA34528BE44040BEDE7137149C2830183018204582040A85BCCB78A25B93D1154E18C5B047227B61A6A22493A4F6AB2167688EE7A908301820458203576B24290DC3A0A5F9B0B007098827B5C2D338C7A89BAEA5A2DAFCF4361892F830183018204582084B8551B9282C2E6ACB665107E7D1B911D5E976439221BB660F470DA10C2C51A8301820458209C4A97A85895A1309261D478A383D0D55FAF0208A7D236354298E3A4DCAD53CD830183018204582064E057E3C9CDE4ED9CECC84B551DE25B198C9C13C2F315BEC964D4C86BBE4F928301820458208AB9D29BC893D62F3EE176019CF5D0C7AD5068E0D893CBD5A39C2C5158386C288301830182045820394DE8F005405C223BFDF78AB9009808FBB4FAEDC6015B7F4A1758EECF6D7379830183024A00000000015018AE0101830182045820782E7694D678049DDDC835BC9FAD6348AF413B557F091D8860ABB3185214983483018302486D6574616461746183018301830182045820E8071E9C904063629F9AB66D4A447B7A881A964D16757762F424D2EF6C6A776B83024E63616E6469643A7365727669636582035946E174797065205A6F6E65446966666963756C7479203D200A2076617269616E74207B0A202020656173793B0A202020686172643B0A2020206D656469756D3B0A207D3B0A74797065205A6F6E65203D200A207265636F7264207B0A2020206465736372697074696F6E3A20746578743B0A202020646966666963756C74793A205A6F6E65446966666963756C74793B0A20202069643A20746578743B0A2020206E616D653A20746578743B0A202020756E6C6F636B526571756972656D656E743A20556E6C6F636B526571756972656D656E743B0A207D3B0A7479706520576F726C6450726F706F73616C203D200A207265636F7264207B0A202020636F6E74656E743A2050726F706F73616C436F6E74656E743B0A20202069643A206E61743B0A20202070726F706F73657249643A207072696E636970616C3B0A2020207374617475733A2050726F706F73616C5374617475733B0A20202074696D65456E643A206F707420696E743B0A20202074696D6553746172743A20696E743B0A202020766F7465733A20766563207265636F7264207B0A202020202020202020202020202020207072696E636970616C3B0A20202020202020202020202020202020566F74653B0A20202020202020202020202020207D3B0A207D3B0A747970652057656967687465645363656E6172696F506174684F7074696F6E203D200A207265636F7264207B0A2020206465736372697074696F6E3A20746578743B0A202020656666656374733A2076656320506174684566666563743B0A2020207061746849643A206F707420746578743B0A2020207765696768743A204F7074696F6E5765696768743B0A207D3B0A74797065205765696768744B696E64203D200A2076617269616E74207B0A2020206174747269627574655363616C65643A204174747269627574653B0A2020207261773B0A207D3B0A7479706520576561706F6E203D200A207265636F7264207B0A202020616374696F6E4964733A2076656320746578743B0A2020206465736372697074696F6E3A20746578743B0A20202069643A20746578743B0A202020696D6167653A20506978656C496D6167653B0A2020206E616D653A20746578743B0A202020756E6C6F636B526571756972656D656E743A20556E6C6F636B526571756972656D656E743B0A207D3B0A7479706520566F74654F6E576F726C6450726F706F73616C526573756C74203D200A2076617269616E74207B0A2020206572723A20566F74654F6E576F726C6450726F706F73616C4572726F723B0A2020206F6B3B0A207D3B0A7479706520566F74654F6E576F726C6450726F706F73616C52657175657374203D200A207265636F7264207B0A20202070726F706F73616C49643A206E61743B0A202020766F74653A20626F6F6C3B0A207D3B0A7479706520566F74654F6E576F726C6450726F706F73616C4572726F72203D200A2076617269616E74207B0A202020616C7265616479566F7465643B0A2020206E6F74456C696769626C653B0A20202070726F706F73616C4E6F74466F756E643B0A202020766F74696E67436C6F7365643B0A207D3B0A7479706520566F7465203D200A207265636F7264207B0A20202063686F6963653A206F707420626F6F6C3B0A202020766F74696E67506F7765723A206E61743B0A207D3B0A7479706520566963746F727947616D654F7574636F6D65576974684D65746144617461203D200A207265636F7264207B0A2020206368617261637465723A20436861726163746572576974684D657461446174613B0A202020756E6C6F636B6564416368696576656D656E744964733A2076656320746578743B0A207D3B0A7479706520557365725374617473203D207265636F7264207B75736572436F756E743A206E61743B7D3B0A747970652055736572203D200A207265636F7264207B0A202020616368696576656D656E744964733A2076656320746578743B0A20202063726561746554696D653A2054696D653B0A20202069643A207072696E636970616C3B0A202020706F696E74733A206E61743B0A207D3B0A7479706520556E6C6F636B526571756972656D656E74203D200A2076617269616E74207B0A202020616368696576656D656E7449643A20746578743B0A2020206E6F6E653B0A207D3B0A74797065205475726E5068617365203D200A2076617269616E74207B0A202020656E643B0A20202073746172743B0A207D3B0A747970652054696D65203D20696E743B0A74797065205461726765744B696E64203D200A2076617269616E74207B0A2020206368617261637465723B0A20202063726561747572653A206E61743B0A202020706572696F6469634566666563743B0A207D3B0A747970652053776170576561706F6E4F7574636F6D65456666656374203D200A207265636F7264207B0A20202072656D6F766564576561706F6E49643A20746578743B0A202020776561706F6E49643A20746578743B0A207D3B0A7479706520537461747573456666656374526573756C744B696E64203D200A2076617269616E74207B0A20202062726974746C653B0A2020206E6563726F7469633B0A202020706572696F6469633A20506572696F646963456666656374526573756C743B0A202020726574616C696174696E673A20526574616C696174696E673B0A2020207374756E6E65643B0A20202076756C6E657261626C653B0A2020207765616B3B0A207D3B0A7479706520537461747573456666656374526573756C74203D200A207265636F7264207B0A2020206B696E643A20537461747573456666656374526573756C744B696E643B0A20202072656D61696E696E675475726E733A206E61743B0A207D3B0A74797065205374617475734566666563744C6F67456E747279203D200A207265636F7264207B0A202020736F757263653A205461726765744B696E643B0A2020207374617475734566666563743A20537461747573456666656374526573756C743B0A2020207461726765743A205461726765744B696E643B0A207D3B0A74797065205374617475734566666563744B696E64203D200A2076617269616E74207B0A20202062726974746C653B0A2020206E6563726F7469633B0A202020726574616C696174696E673A20526574616C696174696E673B0A2020207374756E6E65643B0A20202076756C6E657261626C653B0A2020207765616B3B0A207D3B0A7479706520537461747573456666656374203D200A207265636F7264207B0A2020206475726174696F6E3A206F7074206E61743B0A2020206B696E643A205374617475734566666563744B696E643B0A207D3B0A74797065205374617274696E6747616D655374617465576974684D65746144617461203D207265636F7264207B0A2020202020202020202020202020202020202020202020202020202020202020202020202020206368617261637465724F7074696F6E733A0A2020202020202020202020202020202020202020202020202020202020202020202020202020202076656320436861726163746572576974684D657461446174613B7D3B0A7479706520537461727447616D65526573756C74203D200A2076617269616E74207B0A2020206572723A2076617269616E74207B0A20202020202020202020616C7265616479537461727465643B0A2020202020202020202067616D654E6F74466F756E643B0A20202020202020202020696E76616C696443686172616374657249643B0A20202020202020207D3B0A2020206F6B3B0A207D3B0A7479706520537461727447616D6552657175657374203D207265636F7264207B63686172616374657249643A206E61743B7D3B0A7479706520537461676543686F6963654B696E64203D200A2076617269616E74207B0A20202063686F6963653A20746578743B0A202020636F6D6261743A20436F6D62617443686F6963653B0A2020207265776172643A2052657761726443686F6963653B0A207D3B0A747970652053656C6563745363656E6172696F43686F696365526573756C74203D200A2076617269616E74207B0A2020206572723A2053656C6563745363656E6172696F43686F6963654572726F723B0A2020206F6B3B0A207D3B0A747970652053656C6563745363656E6172696F43686F69636552657175657374203D207265636F7264207B63686F6963653A20537461676543686F6963654B696E643B7D3B0A747970652053656C6563745363656E6172696F43686F6963654572726F72203D200A2076617269616E74207B0A20202067616D654E6F744163746976653B0A20202067616D654E6F74466F756E643B0A202020696E76616C696443686F6963653A20746578743B0A202020696E76616C69645461726765743B0A2020206E6F745363656E6172696F5475726E3B0A20202074617267657452657175697265643B0A207D3B0A74797065205363656E6172696F5374616765526573756C744B696E64203D200A2076617269616E74207B0A20202063686F6963653A205363656E6172696F43686F696365526573756C743B0A202020636F6D6261743A205363656E6172696F436F6D626174526573756C743B0A2020207265776172643A205363656E6172696F526577617264526573756C743B0A207D3B0A74797065205363656E6172696F5374616765526573756C74203D200A207265636F7264207B0A202020656666656374733A20766563204F7574636F6D654566666563743B0A2020206B696E643A205363656E6172696F5374616765526573756C744B696E643B0A207D3B0A74797065205363656E6172696F53746167654B696E64203D200A2076617269616E74207B0A20202063686F6963653A2043686F6963655363656E6172696F53746174653B0A202020636F6D6261743A20436F6D6261745363656E6172696F53746174653B0A2020207265776172643A205265776172645363656E6172696F53746174653B0A207D3B0A74797065205363656E6172696F526577617264526573756C74203D207265636F7264207B6B696E643A205265776172644B696E643B7D3B0A74797065205363656E6172696F506174684B696E64203D200A2076617269616E74207B0A20202063686F6963653A2043686F696365506174683B0A202020636F6D6261743A20436F6D626174506174683B0A2020207265776172643A20526577617264506174683B0A207D3B0A74797065205363656E6172696F50617468203D200A207265636F7264207B0A2020206465736372697074696F6E3A20746578743B0A20202069643A20746578743B0A2020206B696E643A205363656E6172696F506174684B696E643B0A207D3B0A74797065205363656E6172696F4D65746144617461203D200A207265636F7264207B0A20202063617465676F72793A205363656E6172696F43617465676F72793B0A2020206465736372697074696F6E3A20746578743B0A20202069643A20746578743B0A202020696D6167653A20506978656C496D6167653B0A2020206C6F636174696F6E3A204C6F636174696F6E4B696E643B0A2020206E616D653A20746578743B0A20202070617468733A20766563205363656E6172696F506174683B0A202020756E6C6F636B526571756972656D656E743A20556E6C6F636B526571756972656D656E743B0A207D3B0A74797065205363656E6172696F456666656374203D2076617269616E74207B6174747269627574653A204174747269627574655363656E6172696F4566666563743B7D3B0A74797065205363656E6172696F436F6D626174526573756C74203D200A207265636F7264207B0A2020206B696E643A20436F6D626174526573756C744B696E643B0A2020206C6F673A2076656320436F6D6261744C6F67456E7472793B0A207D3B0A74797065205363656E6172696F43686F696365526573756C74203D200A207265636F7264207B0A20202063686F6963653A2043686F6963653B0A2020206B696E643A2043686F696365526573756C744B696E643B0A207D3B0A74797065205363656E6172696F43617465676F7279203D200A2076617269616E74207B0A202020636F6D6261743A20436F6D6261745363656E6172696F43617465676F72793B0A202020656E636F756E7465723B0A20202073746F72653B0A207D3B0A74797065205363656E6172696F203D200A207265636F7264207B0A20202063757272656E7453746167653A205363656E6172696F53746167654B696E643B0A2020206D6574614461746149643A20746578743B0A20202070726576696F75735374616765733A20766563205363656E6172696F5374616765526573756C743B0A207D3B0A7479706520526F7574654C6F636174696F6E4B696E64203D2076617269616E74207B7363656E6172696F3B7D3B0A7479706520526F7574654C6F636174696F6E203D200A207265636F7264207B0A2020206B696E643A20526F7574654C6F636174696F6E4B696E643B0A2020207A6F6E6549643A20746578743B0A207D3B0A74797065205265776172645363656E6172696F5374617465203D200A207265636F7264207B0A2020206E657874506174683A204E657874506174684B696E643B0A2020206F7074696F6E733A207265636F7264207B0A20202020202020202020202020205265776172644B696E643B0A20202020202020202020202020205265776172644B696E643B0A20202020202020202020202020205265776172644B696E643B0A2020202020202020202020207D3B0A207D3B0A7479706520526577617264506174684B696E64203D200A2076617269616E74207B0A20202072616E646F6D3B0A20202073706563696669633A207265636F7264207B0A2020202020202020202020202020205265776172644B696E643B0A2020202020202020202020202020205265776172644B696E643B0A2020202020202020202020202020205265776172644B696E643B0A202020202020202020202020207D3B0A207D3B0A747970652052657761726450617468203D200A207265636F7264207B0A2020206B696E643A20526577617264506174684B696E643B0A2020206E657874506174683A204E657874506174684B696E643B0A207D3B0A74797065205265776172644B696E64203D200A2076617269616E74207B0A202020676F6C643A206E61743B0A2020206865616C74683A206E61743B0A2020206974656D3A20746578743B0A202020776561706F6E3A20746578743B0A207D3B0A747970652052657761726443686F696365203D200A2076617269616E74207B0A202020676F6C643A206E61743B0A2020206865616C74683A206E61743B0A2020206974656D3A204974656D52657761726443686F6963653B0A202020776561706F6E3A20746578743B0A207D3B0A7479706520526574616C696174696E67203D2076617269616E74207B666C61743A206E61743B7D3B0A74797065205265676973746572526573756C74203D200A2076617269616E74207B0A2020206572723A2052656769737465724572726F723B0A2020206F6B3A20557365723B0A207D3B0A747970652052656769737465724572726F72203D2076617269616E74207B616C72656164794D656D6265723B7D3B0A747970652052616365203D200A207265636F7264207B0A2020206465736372697074696F6E3A20746578743B0A20202069643A20746578743B0A202020696D6167653A20506978656C496D6167653B0A2020206E616D653A20746578743B0A2020207374617274696E674974656D4964733A2076656320746578743B0A2020207374617274696E67536B696C6C416374696F6E4964733A2076656320746578743B0A202020756E6C6F636B526571756972656D656E743A20556E6C6F636B526571756972656D656E743B0A207D3B0A747970652050726F706F73616C537461747573203D200A2076617269616E74207B0A20202065786563757465643A0A202020207265636F7264207B0A20202020202063686F6963653A206F707420626F6F6C3B0A202020202020657865637574656454696D653A2054696D653B0A202020202020657865637574696E6754696D653A2054696D653B0A202020207D3B0A202020657865637574696E673A207265636F7264207B0A2020202020202020202020202020202063686F6963653A206F707420626F6F6C3B0A20202020202020202020202020202020657865637574696E6754696D653A2054696D653B0A20202020202020202020202020207D3B0A2020206661696C6564546F457865637574653A0A202020207265636F7264207B0A20202020202063686F6963653A206F707420626F6F6C3B0A2020202020206572726F723A20746578743B0A202020202020657865637574696E6754696D653A2054696D653B0A2020202020206661696C656454696D653A2054696D653B0A202020207D3B0A2020206F70656E3B0A207D3B0A747970652050726F706F73616C436F6E74656E74203D200A2076617269616E74207B0A2020206D6F6469667947616D65436F6E74656E743A204D6F6469667947616D65436F6E74656E743B0A2020206D6F74696F6E3A204D6F74696F6E436F6E74656E743B0A207D3B0A7479706520506978656C496D616765203D200A207265636F7264207B0A20202070616C657474653A20766563207265636F7264207B0A2020202020202020202020202020202020206E6174383B0A2020202020202020202020202020202020206E6174383B0A2020202020202020202020202020202020206E6174383B0A202020202020202020202020202020207D3B0A202020706978656C446174613A2076656320506978656C446174613B0A207D3B0A7479706520506978656C44617461203D200A207265636F7264207B0A202020636F756E743A206E61743B0A20202070616C65747465496E6465783A206F7074206E6174383B0A207D3B0A7479706520506572696F64696354696D696E67203D200A207265636F7264207B0A20202070686173653A205475726E50686173653B0A2020207475726E4475726174696F6E3A206E61743B0A207D3B0A7479706520506572696F646963456666656374526573756C74203D200A207265636F7264207B0A202020616D6F756E743A206E61743B0A2020206B696E643A20506572696F6469634566666563744B696E643B0A20202070686173653A205475726E50686173653B0A207D3B0A7479706520506572696F6469634566666563744B696E64203D200A2076617269616E74207B0A202020626C6F636B3B0A20202064616D6167653B0A2020206865616C3B0A207D3B0A747970652050617468456666656374203D200A2076617269616E74207B0A202020616368696576656D656E743A20746578743B0A2020206164644974656D3A20746578743B0A2020206164644974656D57697468546167733A2076656320746578743B0A20202064616D6167653A204E617456616C75653B0A2020206865616C3A204E617456616C75653B0A20202072656D6F7665476F6C643A204E617456616C75653B0A20202072656D6F76654974656D3A20746578743B0A20202072656D6F76654974656D57697468546167733A2076656320746578743B0A207D3B0A74797065205061676564526573756C745F32203D200A207265636F7264207B0A202020636F756E743A206E61743B0A202020646174613A2076656320436F6D706C6574656447616D65576974684D657461446174613B0A2020206F66667365743A206E61743B0A202020746F74616C436F756E743A206E61743B0A207D3B0A74797065205061676564526573756C745F31203D200A207265636F7264207B0A202020636F756E743A206E61743B0A202020646174613A2076656320557365723B0A2020206F66667365743A206E61743B0A202020746F74616C436F756E743A206E61743B0A207D3B0A74797065205061676564526573756C74203D200A207265636F7264207B0A202020636F756E743A206E61743B0A202020646174613A2076656320576F726C6450726F706F73616C3B0A2020206F66667365743A206E61743B0A202020746F74616C436F756E743A206E61743B0A207D3B0A74797065204F7574636F6D65456666656374203D200A2076617269616E74207B0A2020206164644974656D3A204164644974656D4F7574636F6D654566666563743B0A202020676F6C6444656C74613A20696E743B0A2020206865616C746844656C74613A20696E743B0A2020206D61784865616C746844656C74613A20696E743B0A20202072656D6F76654974656D3A20746578743B0A20202073776170576561706F6E3A2053776170576561706F6E4F7574636F6D654566666563743B0A2020202274657874223A20746578743B0A207D3B0A74797065204F7074696F6E576569676874203D200A207265636F7264207B0A2020206B696E643A205765696768744B696E643B0A20202076616C75653A20666C6F617436343B0A207D3B0A74797065204E657874506174684B696E64203D200A2076617269616E74207B0A2020206D756C74693A207665632057656967687465645363656E6172696F506174684F7074696F6E3B0A2020206E6F6E653B0A20202073696E676C653A20746578743B0A207D3B0A74797065204E617456616C7565203D200A2076617269616E74207B0A20202072616E646F6D3A207265636F7264207B0A202020202020202020202020206E61743B0A202020202020202020202020206E61743B0A20202020202020202020207D3B0A2020207261773A206E61743B0A207D3B0A74797065204D6F74696F6E436F6E74656E74203D200A207265636F7264207B0A2020206465736372697074696F6E3A20746578743B0A2020207469746C653A20746578743B0A207D3B0A74797065204D6F6469667947616D65436F6E74656E74203D200A2076617269616E74207B0A202020616368696576656D656E743A20416368696576656D656E743B0A202020616374696F6E3A20416374696F6E3B0A202020636C6173733A20436C6173733B0A20202063726561747572653A2043726561747572653B0A2020206974656D3A204974656D3B0A202020726163653A20526163653B0A2020207363656E6172696F3A205363656E6172696F4D657461446174613B0A202020776561706F6E3A20576561706F6E3B0A2020207A6F6E653A205A6F6E653B0A207D3B0A74797065204C6F636174696F6E4B696E64203D200A2076617269616E74207B0A202020636F6D6D6F6E3B0A2020207A6F6E654964733A2076656320746578743B0A207D3B0A74797065204974656D52657761726443686F696365203D200A207265636F7264207B0A20202069643A20746578743B0A202020696E76656E746F7279536C6F743A206E61743B0A207D3B0A74797065204974656D203D200A207265636F7264207B0A202020616374696F6E4964733A2076656320746578743B0A2020206465736372697074696F6E3A20746578743B0A20202069643A20746578743B0A202020696D6167653A20506978656C496D6167653B0A2020206E616D653A20746578743B0A202020746167733A2076656320746578743B0A202020756E6C6F636B526571756972656D656E743A20556E6C6F636B526571756972656D656E743B0A207D3B0A7479706520496E76656E746F7279536C6F74576974684D65746144617461203D207265636F7264207B6974656D3A206F7074204974656D3B7D3B0A7479706520496E50726F6772657373526F7574654C6F636174696F6E4B696E64203D2076617269616E74207B7363656E6172696F3A205363656E6172696F3B7D3B0A7479706520496E50726F677265737347616D655374617465576974684D65746144617461203D200A207265636F7264207B0A2020206368617261637465723A20436861726163746572576974684D657461446174613B0A202020636F6D706C657465644C6F636174696F6E733A2076656320436F6D706C65746564526F7574654C6F636174696F6E4B696E643B0A20202063757272656E744C6F636174696F6E3A20496E50726F6772657373526F7574654C6F636174696F6E4B696E643B0A202020726F7574653A2076656320526F7574654C6F636174696F6E3B0A207D3B0A74797065204865616C4C6F67456E747279203D200A207265636F7264207B0A202020616D6F756E743A206E61743B0A202020736F757263653A205461726765744B696E643B0A2020207461726765743A205461726765744B696E643B0A207D3B0A74797065204865616C203D200A207265636F7264207B0A2020206D61783A206E61743B0A2020206D696E3A206E61743B0A20202074696D696E673A20416374696F6E54696D696E674B696E643B0A207D3B0A7479706520476574576F726C6450726F706F73616C526573756C74203D200A2076617269616E74207B0A2020206572723A20476574576F726C6450726F706F73616C4572726F723B0A2020206F6B3A20576F726C6450726F706F73616C3B0A207D3B0A7479706520476574576F726C6450726F706F73616C4572726F72203D2076617269616E74207B70726F706F73616C4E6F74466F756E643B7D3B0A74797065204765745573657273526573756C74203D2076617269616E74207B6F6B3A2076656320557365723B7D3B0A7479706520476574557365727352657175657374203D2076617269616E74207B616C6C3B7D3B0A7479706520476574557365725374617473526573756C74203D200A2076617269616E74207B0A2020206572723B0A2020206F6B3A205573657253746174733B0A207D3B0A747970652047657455736572526573756C74203D200A2076617269616E74207B0A2020206572723A20476574557365724572726F723B0A2020206F6B3A20557365723B0A207D3B0A7479706520476574557365724572726F72203D2076617269616E74207B6E6F74466F756E643B7D3B0A7479706520476574546F705573657273526573756C74203D2076617269616E74207B6F6B3A205061676564526573756C745F313B7D3B0A7479706520476574546F70557365727352657175657374203D200A207265636F7264207B0A202020636F756E743A206E61743B0A2020206F66667365743A206E61743B0A207D3B0A747970652047657443757272656E7447616D65526573756C74203D200A2076617269616E74207B0A2020206572723A2076617269616E74207B6E6F7441757468656E746963617465643B7D3B0A2020206F6B3A206F70742047616D65576974684D657461446174613B0A207D3B0A7479706520476574436F6D706C6574656447616D657352657175657374203D200A207265636F7264207B0A202020636F756E743A206E61743B0A2020206F66667365743A206E61743B0A207D3B0A747970652047616D65576974684D65746144617461203D200A207265636F7264207B0A20202069643A206E61743B0A202020706C6179657249643A207072696E636970616C3B0A202020737461727454696D653A2054696D653B0A20202073746174653A2047616D655374617465576974684D657461446174613B0A207D3B0A747970652047616D655374617465576974684D65746144617461203D200A2076617269616E74207B0A202020636F6D706C657465643A20436F6D706C6574656447616D655374617465576974684D657461446174613B0A202020696E50726F67726573733A20496E50726F677265737347616D655374617465576974684D657461446174613B0A2020207374617274696E673A205374617274696E6747616D655374617465576974684D657461446174613B0A207D3B0A7479706520466F726665697447616D654F7574636F6D65576974684D65746144617461203D207265636F7264207B0A202020202020202020202020202020202020202020202020202020202020202020202020202020206368617261637465723A206F707420436861726163746572576974684D657461446174613B0A20202020202020202020202020202020202020202020202020202020202020202020202020207D3B0A7479706520446561746847616D654F7574636F6D65576974684D65746144617461203D207265636F7264207B6368617261637465723A20436861726163746572576974684D657461446174613B0A2020202020202020202020202020202020202020202020202020202020202020202020207D3B0A747970652044616D6167654C6F67456E747279203D200A207265636F7264207B0A202020616D6F756E743A206E61743B0A202020736F757263653A205461726765744B696E643B0A2020207461726765743A205461726765744B696E643B0A207D3B0A747970652044616D616765203D200A207265636F7264207B0A2020206D61783A206E61743B0A2020206D696E3A206E61743B0A20202074696D696E673A20416374696F6E54696D696E674B696E643B0A207D3B0A747970652043726561747572654C6F636174696F6E4B696E64203D200A2076617269616E74207B0A202020636F6D6D6F6E3B0A2020207A6F6E654964733A2076656320746578743B0A207D3B0A747970652043726561747572654B696E64203D200A2076617269616E74207B0A202020626F73733B0A202020656C6974653B0A2020206E6F726D616C3B0A207D3B0A74797065204372656174757265436F6D6261745374617465203D200A207265636F7264207B0A202020616374696F6E4964733A2076656320746578743B0A202020626C6F636B3A206E61743B0A202020637265617475726549643A20746578743B0A2020206865616C74683A206E61743B0A2020206D61784865616C74683A206E61743B0A202020737461747573456666656374733A2076656320537461747573456666656374526573756C743B0A207D3B0A74797065204372656174757265203D200A207265636F7264207B0A202020616374696F6E4964733A2076656320746578743B0A2020206465736372697074696F6E3A20746578743B0A2020206865616C74683A206E61743B0A20202069643A20746578743B0A2020206B696E643A2043726561747572654B696E643B0A2020206C6F636174696F6E3A2043726561747572654C6F636174696F6E4B696E643B0A2020206D61784865616C74683A206E61743B0A2020206E616D653A20746578743B0A202020756E6C6F636B526571756972656D656E743A20556E6C6F636B526571756972656D656E743B0A207D3B0A7479706520437265617465576F726C6450726F706F73616C526573756C74203D200A2076617269616E74207B0A2020206572723A20437265617465576F726C6450726F706F73616C4572726F723B0A2020206F6B3A206E61743B0A207D3B0A7479706520437265617465576F726C6450726F706F73616C52657175657374203D200A2076617269616E74207B0A2020206D6F6469667947616D65436F6E74656E743A204D6F6469667947616D65436F6E74656E743B0A2020206D6F74696F6E3A204D6F74696F6E436F6E74656E743B0A207D3B0A7479706520437265617465576F726C6450726F706F73616C4572726F72203D200A2076617269616E74207B0A202020696E76616C69643A2076656320746578743B0A2020206E6F74456C696769626C653B0A207D3B0A747970652043726561746547616D65526573756C74203D200A2076617269616E74207B0A2020206572723A2043726561746547616D654572726F723B0A2020206F6B3B0A207D3B0A747970652043726561746547616D6552657175657374203D207265636F7264207B7D3B0A747970652043726561746547616D654572726F72203D200A2076617269616E74207B0A202020616C7265616479496E697469616C697A65643B0A2020206E6F436C61737365733B0A2020206E6F4372656174757265733B0A2020206E6F437265617475726573466F725A6F6E653A20746578743B0A2020206E6F4974656D733B0A2020206E6F52616365733B0A2020206E6F5363656E6172696F733B0A2020206E6F5363656E6172696F73466F725A6F6E653A20746578743B0A2020206E6F576561706F6E733B0A2020206E6F5A6F6E65733B0A2020206E6F7441757468656E746963617465643B0A202020757365724E6F74526567697374657265643B0A207D3B0A7479706520436F6D706C657465645363656E6172696F203D200A207265636F7264207B0A2020206D6574614461746149643A20746578743B0A2020207374616765733A20766563205363656E6172696F5374616765526573756C743B0A207D3B0A7479706520436F6D706C65746564526F7574654C6F636174696F6E4B696E64203D2076617269616E74207B7363656E6172696F3A20436F6D706C657465645363656E6172696F3B7D3B0A7479706520436F6D706C6574656447616D65576974684D65746144617461203D200A207265636F7264207B0A202020656E6454696D653A2054696D653B0A20202069643A206E61743B0A2020206F7574636F6D653A20436F6D706C6574656447616D654F7574636F6D65576974684D657461446174613B0A202020706C6179657249643A207072696E636970616C3B0A202020726F7574653A2076656320436F6D706C6574656447616D65526F7574654C6F636174696F6E3B0A202020737461727454696D653A2054696D653B0A207D3B0A7479706520436F6D706C6574656447616D655374617465576974684D65746144617461203D200A207265636F7264207B0A202020656E6454696D653A2054696D653B0A2020206F7574636F6D653A20436F6D706C6574656447616D654F7574636F6D65576974684D657461446174613B0A202020726F7574653A2076656320436F6D706C6574656447616D65526F7574654C6F636174696F6E3B0A207D3B0A7479706520436F6D706C6574656447616D65526F7574654C6F636174696F6E4B696E64203D200A2076617269616E74207B0A2020206E6F74537461727465643A20526F7574654C6F636174696F6E4B696E643B0A2020207363656E6172696F3A20436F6D706C657465645363656E6172696F3B0A207D3B0A7479706520436F6D706C6574656447616D65526F7574654C6F636174696F6E203D200A207265636F7264207B0A2020206B696E643A20436F6D706C6574656447616D65526F7574654C6F636174696F6E4B696E643B0A2020207A6F6E6549643A20746578743B0A207D3B0A7479706520436F6D706C6574656447616D654F7574636F6D65576974684D65746144617461203D200A2076617269616E74207B0A20202064656174683A20446561746847616D654F7574636F6D65576974684D657461446174613B0A202020666F72666569743A20466F726665697447616D654F7574636F6D65576974684D657461446174613B0A202020766963746F72793A20566963746F727947616D654F7574636F6D65576974684D657461446174613B0A207D3B0A7479706520436F6D626174566963746F7279526573756C74203D207265636F7264207B6368617261637465724865616C74683A206E61743B7D3B0A7479706520436F6D6261745363656E6172696F5374617465203D200A207265636F7264207B0A2020206368617261637465723A20436861726163746572436F6D62617453746174653B0A2020206372656174757265733A20766563204372656174757265436F6D62617453746174653B0A2020206E657874506174683A204E657874506174684B696E643B0A207D3B0A7479706520436F6D6261745363656E6172696F43617465676F7279203D200A2076617269616E74207B0A202020626F73733B0A202020656C6974653B0A2020206E6F726D616C3B0A207D3B0A7479706520436F6D626174526573756C744B696E64203D200A2076617269616E74207B0A2020206465666561743A20436F6D626174446566656174526573756C743B0A202020696E50726F67726573733A20436F6D6261745363656E6172696F53746174653B0A202020766963746F72793A20436F6D626174566963746F7279526573756C743B0A207D3B0A7479706520436F6D62617450617468203D200A207265636F7264207B0A2020206372656174757265733A2076656320436F6D62617443726561747572654B696E643B0A2020206E657874506174683A204E657874506174684B696E643B0A207D3B0A7479706520436F6D6261744C6F67456E747279203D200A2076617269616E74207B0A202020626C6F636B3A20426C6F636B4C6F67456E7472793B0A20202064616D6167653A2044616D6167654C6F67456E7472793B0A2020206865616C3A204865616C4C6F67456E7472793B0A2020207374617475734566666563743A205374617475734566666563744C6F67456E7472793B0A207D3B0A7479706520436F6D626174456666656374546172676574203D200A2076617269616E74207B0A20202073656C663B0A202020746172676574733B0A207D3B0A7479706520436F6D6261744566666563744B696E64203D200A2076617269616E74207B0A2020206164645374617475734566666563743A205374617475734566666563743B0A202020626C6F636B3A20426C6F636B3B0A20202064616D6167653A2044616D6167653B0A2020206865616C3A204865616C3B0A207D3B0A7479706520436F6D626174456666656374203D200A207265636F7264207B0A2020206B696E643A20436F6D6261744566666563744B696E643B0A2020207461726765743A20436F6D6261744566666563745461726765743B0A207D3B0A7479706520436F6D626174446566656174526573756C74203D207265636F7264207B6372656174757265733A20766563204372656174757265436F6D62617453746174653B7D3B0A7479706520436F6D62617443726561747572654C6F636174696F6E46696C746572203D200A2076617269616E74207B0A202020616E793B0A202020636F6D6D6F6E3B0A2020207A6F6E653A20746578743B0A207D3B0A7479706520436F6D62617443726561747572654B696E64203D200A2076617269616E74207B0A20202066696C7465723A20436F6D626174437265617475726546696C7465723B0A20202069643A20746578743B0A207D3B0A7479706520436F6D626174437265617475726546696C746572203D207265636F7264207B6C6F636174696F6E3A20436F6D62617443726561747572654C6F636174696F6E46696C7465723B7D3B0A7479706520436F6D62617443686F696365203D200A207265636F7264207B0A2020206B696E643A20436861726163746572416374696F6E4B696E643B0A2020207461726765743A206F707420416374696F6E546172676574526573756C743B0A207D3B0A7479706520436C617373203D200A207265636F7264207B0A2020206465736372697074696F6E3A20746578743B0A20202069643A20746578743B0A202020696D6167653A20506978656C496D6167653B0A2020206E616D653A20746578743B0A2020207374617274696E674974656D4964733A2076656320746578743B0A2020207374617274696E67536B696C6C416374696F6E4964733A2076656320746578743B0A202020756E6C6F636B526571756972656D656E743A20556E6C6F636B526571756972656D656E743B0A202020776561706F6E49643A20746578743B0A207D3B0A747970652043686F6963655363656E6172696F5374617465203D207265636F7264207B63686F696365733A207665632043686F6963653B7D3B0A747970652043686F696365526573756C744B696E64203D200A2076617269616E74207B0A202020636F6D706C6574653B0A20202064656174683B0A207D3B0A747970652043686F696365526571756972656D656E74203D200A2076617269616E74207B0A2020206174747269627574653A2041747472696275746543686F696365526571756972656D656E743B0A202020676F6C643A206E61743B0A2020206974656D57697468546167733A2076656320746578743B0A207D3B0A747970652043686F69636550617468203D207265636F7264207B63686F696365733A207665632043686F6963653B7D3B0A747970652043686F696365203D200A207265636F7264207B0A2020206465736372697074696F6E3A20746578743B0A202020656666656374733A2076656320506174684566666563743B0A20202069643A20746578743B0A2020206E657874506174683A204E657874506174684B696E643B0A202020726571756972656D656E743A206F70742043686F696365526571756972656D656E743B0A207D3B0A7479706520436861726163746572576974684D65746144617461203D200A207265636F7264207B0A202020616374696F6E733A2076656320436861726163746572416374696F6E576974684D657461446174613B0A202020617474726962757465733A20436861726163746572417474726962757465733B0A202020636C6173733A20436C6173733B0A202020676F6C643A206E61743B0A2020206865616C74683A206E61743B0A202020696E76656E746F7279536C6F74733A2076656320496E76656E746F7279536C6F74576974684D657461446174613B0A2020206D61784865616C74683A206E61743B0A202020726163653A20526163653B0A202020776561706F6E3A20576561706F6E3B0A207D3B0A7479706520436861726163746572436F6D6261745374617465203D200A207265636F7264207B0A202020626C6F636B3A206E61743B0A2020206865616C74683A206E61743B0A2020206974656D416374696F6E49643A206F707420746578743B0A2020206D61784865616C74683A206E61743B0A202020736B696C6C416374696F6E49643A206F707420746578743B0A202020737461747573456666656374733A2076656320537461747573456666656374526573756C743B0A202020776561706F6E416374696F6E49643A206F707420746578743B0A207D3B0A747970652043686172616374657241747472696275746573203D200A207265636F7264207B0A2020206368617269736D613A20696E743B0A2020206465787465726974793A20696E743B0A202020737472656E6774683A20696E743B0A202020776973646F6D3A20696E743B0A207D3B0A7479706520436861726163746572416374696F6E576974684D65746144617461203D200A207265636F7264207B0A202020616374696F6E3A20416374696F6E3B0A2020206B696E643A20436861726163746572416374696F6E4B696E643B0A207D3B0A7479706520436861726163746572416374696F6E4B696E64203D200A2076617269616E74207B0A2020206974656D3B0A202020736B696C6C3B0A202020776561706F6E3B0A207D3B0A7479706520426C6F636B4C6F67456E747279203D200A207265636F7264207B0A202020616D6F756E743A206E61743B0A202020736F757263653A205461726765744B696E643B0A2020207461726765743A205461726765744B696E643B0A207D3B0A7479706520426C6F636B203D200A207265636F7264207B0A2020206D61783A206E61743B0A2020206D696E3A206E61743B0A20202074696D696E673A20416374696F6E54696D696E674B696E643B0A207D3B0A74797065204174747269627574655363656E6172696F456666656374203D200A207265636F7264207B0A2020206174747269627574653A204174747269627574653B0A20202076616C75653A20696E743B0A207D3B0A747970652041747472696275746543686F696365526571756972656D656E74203D200A207265636F7264207B0A2020206174747269627574653A204174747269627574653B0A20202076616C75653A20696E743B0A207D3B0A7479706520417474726962757465203D200A2076617269616E74207B0A2020206368617269736D613B0A2020206465787465726974793B0A202020737472656E6774683B0A202020776973646F6D3B0A207D3B0A74797065204164644974656D4F7574636F6D65456666656374203D200A207265636F7264207B0A2020206974656D49643A20746578743B0A20202072656D6F7665644974656D49643A206F707420746578743B0A207D3B0A7479706520416374696F6E54696D696E674B696E64203D200A2076617269616E74207B0A202020696D6D6564696174653B0A202020706572696F6469633A20506572696F64696354696D696E673B0A207D3B0A7479706520416374696F6E54617267657453656C656374696F6E203D200A2076617269616E74207B0A202020616C6C3B0A20202063686F73656E3B0A20202072616E646F6D3A207265636F7264207B636F756E743A206E61743B7D3B0A207D3B0A7479706520416374696F6E54617267657453636F7065203D200A2076617269616E74207B0A202020616C6C793B0A202020616E793B0A202020656E656D793B0A207D3B0A7479706520416374696F6E546172676574526573756C74203D200A2076617269616E74207B0A2020206368617261637465723B0A20202063726561747572653A206E61743B0A207D3B0A7479706520416374696F6E546172676574203D200A207265636F7264207B0A20202073636F70653A20416374696F6E54617267657453636F70653B0A20202073656C656374696F6E3A20416374696F6E54617267657453656C656374696F6E3B0A207D3B0A7479706520416374696F6E203D200A207265636F7264207B0A202020636F6D626174456666656374733A2076656320436F6D6261744566666563743B0A2020206465736372697074696F6E3A20746578743B0A20202069643A20746578743B0A2020206E616D653A20746578743B0A2020207363656E6172696F456666656374733A20766563205363656E6172696F4566666563743B0A2020207461726765743A20416374696F6E5461726765743B0A207D3B0A7479706520416368696576656D656E74203D200A207265636F7264207B0A2020206465736372697074696F6E3A20746578743B0A20202069643A20746578743B0A2020206E616D653A20746578743B0A207D3B0A74797065204162616E646F6E47616D65526573756C74203D200A2076617269616E74207B0A2020206572723A2076617269616E74207B6E6F41637469766547616D653B7D3B0A2020206F6B3B0A207D3B0A73657276696365203A207B0A20206162616E646F6E47616D653A202829202D3E20284162616E646F6E47616D65526573756C74293B0A202063726561746547616D653A202843726561746547616D655265717565737429202D3E202843726561746547616D65526573756C74293B0A2020637265617465576F726C6450726F706F73616C3A2028437265617465576F726C6450726F706F73616C5265717565737429202D3E0A20202028437265617465576F726C6450726F706F73616C526573756C74293B0A2020676574416368696576656D656E74733A202829202D3E202876656320416368696576656D656E74292071756572793B0A2020676574416374696F6E733A202829202D3E202876656320416374696F6E292071756572793B0A2020676574436C61737365733A202829202D3E202876656320436C617373292071756572793B0A2020676574436F6D706C6574656447616D65733A2028476574436F6D706C6574656447616D65735265717565737429202D3E20285061676564526573756C745F32292071756572793B0A20206765744372656174757265733A202829202D3E2028766563204372656174757265292071756572793B0A202067657443757272656E7447616D653A202829202D3E202847657443757272656E7447616D65526573756C74292071756572793B0A20206765744974656D733A202829202D3E2028766563204974656D292071756572793B0A202067657452616365733A202829202D3E20287665632052616365292071756572793B0A20206765745363656E6172696F4D657461446174614C6973743A202829202D3E2028766563205363656E6172696F4D65746144617461292071756572793B0A2020676574546F7055736572733A2028476574546F7055736572735265717565737429202D3E2028476574546F705573657273526573756C74292071756572793B0A2020676574557365723A20287072696E636970616C29202D3E202847657455736572526573756C74292071756572793B0A20206765745573657253746174733A202829202D3E2028476574557365725374617473526573756C74292071756572793B0A202067657455736572733A202847657455736572735265717565737429202D3E20284765745573657273526573756C74292071756572793B0A2020676574576561706F6E733A202829202D3E202876656320576561706F6E292071756572793B0A2020676574576F726C6450726F706F73616C3A20286E617429202D3E2028476574576F726C6450726F706F73616C526573756C74292071756572793B0A2020676574576F726C6450726F706F73616C733A20286E61742C206E617429202D3E20285061676564526573756C74292071756572793B0A20206765745A6F6E65733A202829202D3E2028766563205A6F6E65292071756572793B0A202072656769737465723A202829202D3E20285265676973746572526573756C74293B0A202073656C6563745363656E6172696F43686F6963653A202853656C6563745363656E6172696F43686F6963655265717565737429202D3E0A2020202853656C6563745363656E6172696F43686F696365526573756C74293B0A2020737461727447616D653A2028537461727447616D655265717565737429202D3E2028537461727447616D65526573756C74293B0A2020766F74654F6E576F726C6450726F706F73616C3A2028566F74654F6E576F726C6450726F706F73616C5265717565737429202D3E0A20202028566F74654F6E576F726C6450726F706F73616C526573756C74293B0A7D0A8204582087FDA0FB2A045F48A62181613D2122A8569F2962B506D3BFED788F5D311A4AEF82045820FAF863998F27206BD4DB9F061EC3DEFE7AE468A81C2B6BC61D4A2F03CBC267AB820458209EDF884A5D50509DD18C30E09A9A55B88AFE12457F4508EE5755FF4A17F969CF82045820CDF0A6C05B74AC41336CE2FE73ABE8BE3EE870E8894EDD6EF38BADAAD96275488204582018752817CA82FCD8EF4FD2462A013A1CFBEE9CE3215E0777E8F96AD64B46453282045820E8D2528773390A64B93EC05AC76795468BC808E5328C43FFD6DA228957004A8382045820A70A22DCF34B8D717AE80D694E9131C1DB726E173688118F842BBCADBE030E5C820458204DBFD19923C3AA0355DF0891D9403BB246B90623199834397A9752F1328FAD3E820458206CBA74F259AC6CF21B10DFD9ACCF4A2AC410A20CCBB74DE15A5061C032831F2B820458204A548D0DB1D48F6651ED20299FCF4C740B14DF3B19706A0282BB0B9C666BC960820458203FD0C9AD83F5B4B01CE7550A0E75FDEC15DF82B3F29B5D5286013BC246C93595820458201C2341C43046B56EA6D03BCAFAB4B440C094477258DD6BA0C82D4111B4FD98A4830182045820898FA765A188D161A3E3057DF3017DCFA386D0B8A7A99C6BAE6FD765315DAADA83024474696D65820349AAC7FE98E8E4809718697369676E61747572655830810FB38F08F0DD42843E98CA8ED8FB974FC8552BFA38B8674F2F8C2EBDAE35E936AEDF694EEEE8073C308A63F7DF0F8D6A64656C65676174696F6EA2697375626E65745F6964581D12790E7661FCCD3D4FC83138DCAFFD9F188E867B45AE10C8836DD0B8026B636572746966696361746559027DD9D9F7A2647472656583018204582010B2306F17FE9FB46372B81FAB1254A9F00308C4E70DFEE8B7065F3BCF0783FB8301830182045820CCD98C76B7A404042F0D5189CFB02D006D041299AD834CC490FA220E10317F458302467375626E65748301830183018301830182045820D1D38FFCAEFC49B6417EF6F5F39B4BAE46280F55F4F5D8BE681BD480083E8897830182045820051E96B350B6E2B39063D9D735FD9A6F13AA672FB140E3A6E7D8A095BF5AE0B08302581D12790E7661FCCD3D4FC83138DCAFFD9F188E867B45AE10C8836DD0B802830183024F63616E69737465725F72616E6765738203581BD9D9F781824A000000000150000001014A00000000015FFFFF010183024A7075626C69635F6B657982035885308182301D060D2B0601040182DC7C0503010201060C2B0601040182DC7C0503020103610086D88EBBD2F1663E65D3A3FF07E8EE9FA420D08B9A6822919F224B8B802D5D9BE150DC493F84C23E73A0CC1D2C2EE28709FF140000128FCD5DFBD7B457EF3AF344766D7FF0924FE7A7F456DED77CA6DE3B1B406B710C4EAED7287AB9A35276698204582052A3D0680479A713A022877C63B5B0AFFEDF60D10A2E2BA29AFC207EB5E92F248204582088FEA0DB69F38F9CF3FBA88F8A040F3CADC9AE7772FA1A406A6EA464FA858B9E820458206961EF137C2AEE0B0467082EF6D3C12C03E93013B602A4CB6214270E484863F18204582051A4F98FADBC89C3808F82BC45232C0DCFD454944619552F02E4457F4D8940A083024474696D65820349A083E5A8A4F1999618697369676E6174757265583085FE308F26E69B1CF5EE5215534A79B21F3BA78D192CBFD83A6885E9C76F10E2D44F34948B2E32D1D31E825A1FC6FB5C");

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/canister/") && url.Contains("/read_state")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken?>()))
		//		.ReturnsAsync(CreateHttpResponse(HttpStatusCode.OK, readStateResponseBytes));

		//	// Act
		//	var result = await agent.CallAsync(signedContent);

		//	// Assert
		//	Assert.NotNull(result);
		//	Assert.Equal("hello", result.ToObjects<string>());
		//}

		//[Fact]
		//public async Task CallAsync_RejectedResponse_ThrowsCallRejectedException()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object, skipCertificateValidation: true);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));
		//	CallRequest request = new(canisterId, "greet", CandidArg.FromCandid(), sender, ingressExpiry);
		//	var signedContent = identity.Sign(request);


		//	byte[] responseBytes = [];
		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.OK, responseBytes);

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v3/canister/")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act & Assert
		//	var exception = await Assert.ThrowsAsync<CallRejectedException>(
		//		async () => await agent.CallAsync(signedContent));

		//	Assert.Equal(RejectCode.CanisterError, exception.RejectCode);
		//	Assert.Equal("Test error message", exception.Message);
		//	Assert.Equal("TEST_ERROR", exception.ErrorCode);
		//}

		//[Fact]
		//public async Task QueryAsync_SuccessfulResponse_ReturnsReply()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));
		//	QueryRequest request = new(canisterId, "greet", CandidArg.FromCandid(), sender, ingressExpiry);
		//	var signedContent = identity.Sign(request);


		//	byte[] responseBytes = [];
		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.OK, responseBytes);

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/canister/") && url.Contains("/query")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act
		//	var result = await agent.QueryAsync(signedContent);

		//	// Assert
		//	Assert.NotNull(result);
		//	Assert.Equal("hello", result.ToObjects<string>());
		//}

		//[Fact]
		//public async Task QueryAsync_RejectedResponse_ThrowsCallRejectedException()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));

		//	QueryRequest request = new(canisterId, "greet", CandidArg.FromCandid(), sender, ingressExpiry);
		//	SignedRequest<QueryRequest> signedContent = identity.Sign(request);

		//	byte[] responseBytes = [];
		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.OK, responseBytes);

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/canister/") && url.Contains("/query")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act & Assert
		//	var exception = await Assert.ThrowsAsync<CallRejectedException>(
		//		async () => await agent.QueryAsync(signedContent));

		//	Assert.Equal(RejectCode.CanisterError, exception.RejectCode);
		//	Assert.Equal("Test error message", exception.Message);
		//	Assert.Equal("TEST_ERROR", exception.ErrorCode);
		//}

		//[Fact]
		//public async Task ReadStateAsync_SuccessfulResponse_ReturnsCertificate()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object, skipCertificateValidation: true);

		//	RequestId requestId = RequestId.FromBytes(new byte[32]);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));
		//	List<StatePath> paths = [
		//		StatePath.FromSegments("request_status", requestId.RawValue)
		//	];
		//	ReadStateRequest request = new(paths, sender, ingressExpiry);
		//	var signedContent = identity.Sign(request);

		//	byte[] responseBytes = [];

		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.OK, responseBytes);

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/canister/") && url.Contains("/read_state")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act
		//	var result = await agent.ReadStateAsync(canisterId, signedContent);

		//	// Assert
		//	Assert.NotNull(result);
		//	Assert.NotNull(result.Certificate);

		//	RequestStatus? requestStatus = IAgentExtensions.ParseRequestStatus(
		//		result.Certificate.Tree.GetValueOrDefault(StatePath.FromSegments("request_status", requestId.RawValue))
		//	);

		//	Assert.Equal(RequestStatus.StatusType.Replied, requestStatus?.Type);
		//	Assert.Equal("hello", requestStatus?.AsReplied().ToObjects<string>());
		//}

		//[Fact]
		//public async Task GetRootKeyAsync_StatusResponse_ReturnsRootKey()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object);

		//	// Mock status response with development root key
		//	byte[] rootKeyBytes = new byte[] { 0x30, 0x82, 0x01, 0x22, 0x30, 0x0D, 0x06, 0x09, 0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x01, 0x01, 0x05, 0x00 };


		//	byte[] responseBytes = [];
		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.OK, responseBytes);

		//	httpClientMock.Setup(c => c.GetAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/status")),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act
		//	SubjectPublicKeyInfo result = await agent.GetRootKeyAsync();

		//	// Assert
		//	Assert.NotNull(result);
		//	// Compare DER encodings
		//	Assert.Equal(rootKeyBytes, result.ToDerEncoding());
		//}

		//[Fact]
		//public async Task GetRootKeyAsync_NoDevRootKey_ReturnsMainNetKey()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object);

		//	// Mock status response without development root key
		//	StatusResponse statusResponse = new(
		//		icApiVersion: null,
		//		implementationSource: null,
		//		implementationVersion: null,
		//		implementationRevision: null,
		//		developmentRootKey: null
		//	);

		//	byte[] responseBytes = [];
		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.OK, responseBytes);

		//	httpClientMock.Setup(c => c.GetAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/status")),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act
		//	SubjectPublicKeyInfo result = await agent.GetRootKeyAsync();

		//	// Assert
		//	Assert.NotNull(result);
		//	// Should be main net key
		//	Assert.Equal(SubjectPublicKeyInfo.MainNetRootPublicKey.ToDerEncoding(), result.ToDerEncoding());
		//}

		//[Fact]
		//public async Task CallAsynchronousAsync_SuccessfulResponse_ReturnsRequestId()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));
		//	CallRequest request = new(canisterId, "greet", CandidArg.FromCandid(), sender, ingressExpiry);
		//	var signedContent = identity.Sign(request);
		//	RequestId requestId = signedContent.GetOrBuildRequestId();

		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.Accepted, Array.Empty<byte>());

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/canister/") && url.Contains("/call")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act
		//	var result = await agent.CallAsynchronousAsync(signedContent);

		//	// Assert
		//	Assert.Equal(requestId, result);
		//}

		//[Fact]
		//public async Task CallAsynchronousAsync_RejectedResponse_ThrowsCallRejectedException()
		//{
		//	// Arrange
		//	Mock<IHttpClient> httpClientMock = new();
		//	HttpAgent agent = new(httpClientMock.Object);

		//	Principal sender = identity.GetPrincipal();
		//	ICTimestamp ingressExpiry = ICTimestamp.Future(TimeSpan.FromMinutes(1));
		//	CallRequest request = new(canisterId, "greet", CandidArg.FromCandid(), sender, ingressExpiry);
		//	var signedContent = identity.Sign(request);


		//	byte[] responseBytes = [];
		//	HttpResponse httpResponse = CreateHttpResponse(HttpStatusCode.OK, responseBytes);

		//	httpClientMock.Setup(c => c.PostAsync(
		//		It.Is<string>(url => url.Contains("/api/v2/canister/") && url.Contains("/call")),
		//		It.IsAny<byte[]>(),
		//		It.IsAny<CancellationToken>()))
		//		.ReturnsAsync(httpResponse);

		//	// Act & Assert
		//	var exception = await Assert.ThrowsAsync<CallRejectedException>(
		//		async () => await agent.CallAsynchronousAsync(signedContent));

		//	Assert.Equal(RejectCode.CanisterError, exception.RejectCode);
		//	Assert.Equal("Test error message", exception.Message);
		//	Assert.Equal("TEST_ERROR", exception.ErrorCode);
		//}

		#region Helper Methods

		private static HttpResponse CreateHttpResponse(HttpStatusCode statusCode, byte[] content)
		{
			return new HttpResponse(statusCode, () => Task.FromResult(content));
		}

		#endregion
	}
}
